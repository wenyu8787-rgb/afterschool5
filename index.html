<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新上國小課後社團報名系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Prevent flash of unstyled content -->
    <style>
        body { display: none; }
        /* Custom scrollbar for modals */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Imports from CDNs ---
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Lucide Icons
        import { 
            User, LogOut, Calendar, Clock, MapPin, DollarSign, Users, Settings, 
            Plus, Trash2, Edit, Download, Upload, AlertTriangle, FileSpreadsheet, 
            CheckCircle, Phone, Loader2, Shield, List, XCircle, FileUp, Filter,
            Info, BookOpen, RefreshCw, UserCog, Lock, Search
        } from 'https://esm.sh/lucide-react@0.292.0';

        // Firebase SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            signOut, onAuthStateChanged, updateProfile, updatePassword 
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { 
            getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, 
            updateDoc, deleteDoc, onSnapshot, query, where, serverTimestamp, 
            writeBatch, increment, limit 
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJTRVbX6tYLPuUeQ22Na4JLhII6BrHW6o",
            authDomain: "afterschool-8afcf.firebaseapp.com",
            projectId: "afterschool-8afcf",
            storageBucket: "afterschool-8afcf.firebasestorage.app",
            messagingSenderId: "503971252052",
            appId: "1:503971252052:web:750301c13a1bd88258eac1",
            measurementId: "G-ZKY26DX7E9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Helper for App ID
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Helper Functions for CSV ---

        const escapeCSV = (str) => {
            if (str === null || str === undefined) return '';
            const stringValue = String(str);
            if (stringValue.includes('"') || stringValue.includes(',') || stringValue.includes('\n')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return stringValue;
        };

        const parseCSVLine = (text) => {
            const result = [];
            let startValueIndex = 0;
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                if (text[i] === '"') {
                    inQuotes = !inQuotes;
                } else if (text[i] === ',' && !inQuotes) {
                    let field = text.substring(startValueIndex, i);
                    if (field.startsWith('"') && field.endsWith('"')) {
                        field = field.slice(1, -1).replace(/""/g, '"');
                    }
                    result.push(field.trim());
                    startValueIndex = i + 1;
                }
            }
            let lastField = text.substring(startValueIndex);
            if (lastField.startsWith('"') && lastField.endsWith('"')) {
                lastField = lastField.slice(1, -1).replace(/""/g, '"');
            }
            result.push(lastField.trim());
            return result;
        };

        // --- Components ---

        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgColor = type === 'error' ? 'bg-red-100 text-red-800 border-red-200' : 'bg-green-100 text-green-800 border-green-200';
            
            return (
                <div className="fixed top-4 right-4 z-50 animate-fade-in">
                    <div className={`px-4 py-3 rounded-lg shadow-lg border flex items-center gap-2 ${bgColor}`}>
                        {type === 'error' ? <AlertTriangle size={18} /> : <CheckCircle size={18} />}
                        <span>{message}</span>
                        <button onClick={onClose} className="ml-4 font-bold hover:opacity-75">✕</button>
                    </div>
                </div>
            );
        };

        // --- 1. User Profile Modal ---
        const ProfileModal = ({ isOpen, onClose, user, userProfile, onUpdate }) => {
            const [name, setName] = useState('');
            const [phone, setPhone] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (isOpen && userProfile) {
                    setName(userProfile.name || user?.displayName || '');
                    setPhone(userProfile.phone || '');
                    setNewPassword('');
                }
            }, [isOpen, userProfile, user]);

            if (!isOpen) return null;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await onUpdate(name, phone, newPassword);
                    onClose();
                } catch (error) {
                    // Error handled by parent
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="bg-indigo-600 p-4 text-white font-bold text-xl flex justify-between items-center">
                            <span className="flex items-center gap-2"><UserCog size={24}/> 修改個人資料</span>
                            <button onClick={onClose} className="hover:text-indigo-200">✕</button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                                <input type="text" required className="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none" value={name} onChange={(e) => setName(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">聯絡電話</label>
                                <input type="tel" required className="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none" value={phone} onChange={(e) => setPhone(e.target.value)} />
                            </div>
                            <div className="pt-2 border-t">
                                <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1">
                                    <Lock size={14}/> 變更密碼 (若不修改請留白)
                                </label>
                                <input type="password" className="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} placeholder="輸入新密碼 (至少6碼)" minLength="6" />
                                <p className="text-xs text-gray-500 mt-1">注意：修改密碼可能需要您重新登入。</p>
                            </div>
                            <div className="pt-2 flex gap-3">
                                <button type="button" onClick={onClose} className="flex-1 bg-gray-100 text-gray-700 py-2 rounded hover:bg-gray-200">取消</button>
                                <button type="submit" disabled={loading} className="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 disabled:opacity-50">
                                    {loading ? '儲存中...' : '儲存變更'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- 2. Admin Member Management Modal ---
        const MemberManagementModal = ({ isOpen, onClose, onEditUser, onDeleteUser }) => {
            const [members, setMembers] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [editingMember, setEditingMember] = useState(null);
            const appId = getAppId();

            useEffect(() => {
                if (isOpen) {
                    const fetchMembers = async () => {
                        setLoading(true);
                        try {
                            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                            const snapshot = await getDocs(usersRef);
                            const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setMembers(list);
                        } catch (err) {
                            console.error("Error fetching members:", err);
                        } finally {
                            setLoading(false);
                        }
                    };
                    fetchMembers();
                } else {
                    setEditingMember(null);
                }
            }, [isOpen]);

            const filteredMembers = members.filter(m => 
                (m.name?.toLowerCase() || '').includes(searchTerm.toLowerCase()) || 
                (m.email?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
                (m.phone?.toLowerCase() || '').includes(searchTerm.toLowerCase())
            );

            const handleSaveEdit = async (e) => {
                e.preventDefault();
                if (!editingMember) return;
                await onEditUser(editingMember.id, {
                    name: editingMember.name,
                    phone: editingMember.phone,
                    role: editingMember.role
                });
                setMembers(prev => prev.map(m => m.id === editingMember.id ? editingMember : m));
                setEditingMember(null);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-gray-800 p-4 text-white font-bold text-xl flex justify-between items-center">
                            <span className="flex items-center gap-2"><Users size={24}/> 會員管理</span>
                            <button onClick={onClose} className="hover:text-gray-300">✕</button>
                        </div>
                        
                        <div className="p-4 border-b bg-gray-50 flex justify-between items-center gap-4">
                            <div className="relative flex-1">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
                                <input 
                                    type="text" 
                                    placeholder="搜尋姓名、Email 或電話..." 
                                    className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <div className="text-sm text-gray-500">共 {filteredMembers.length} 位會員</div>
                        </div>

                        <div className="overflow-y-auto flex-1 p-4 custom-scrollbar">
                            {editingMember ? (
                                <form onSubmit={handleSaveEdit} className="space-y-4 max-w-md mx-auto bg-gray-50 p-6 rounded-lg border">
                                    <h3 className="font-bold text-lg text-center mb-4">編輯會員資料</h3>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700">姓名</label>
                                        <input type="text" required className="w-full p-2 border rounded" value={editingMember.name} onChange={e => setEditingMember({...editingMember, name: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700">電話</label>
                                        <input type="text" required className="w-full p-2 border rounded" value={editingMember.phone} onChange={e => setEditingMember({...editingMember, phone: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700">權限角色</label>
                                        <select className="w-full p-2 border rounded bg-white" value={editingMember.role} onChange={e => setEditingMember({...editingMember, role: e.target.value})}>
                                            <option value="user">一般會員 (user)</option>
                                            <option value="admin">管理員 (admin)</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 pt-4">
                                        <button type="button" onClick={() => setEditingMember(null)} className="flex-1 bg-gray-200 py-2 rounded hover:bg-gray-300">取消</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">儲存</button>
                                    </div>
                                </form>
                            ) : (
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold sticky top-0">
                                        <tr>
                                            <th className="px-4 py-2">姓名</th>
                                            <th className="px-4 py-2">Email</th>
                                            <th className="px-4 py-2">電話</th>
                                            <th className="px-4 py-2">角色</th>
                                            <th className="px-4 py-2 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredMembers.map(m => (
                                            <tr key={m.id} className="hover:bg-gray-50">
                                                <td className="px-4 py-3 font-medium">{m.name}</td>
                                                <td className="px-4 py-3 text-gray-600">{m.email}</td>
                                                <td className="px-4 py-3">{m.phone}</td>
                                                <td className="px-4 py-3">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${m.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}`}>
                                                        {m.role}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-right flex justify-end gap-2">
                                                    <button onClick={() => setEditingMember(m)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded" title="編輯">
                                                        <Edit size={16}/>
                                                    </button>
                                                    <button 
                                                        onClick={async () => {
                                                            if(confirm(`確定要刪除會員 ${m.name} 嗎？這將無法復原。`)) {
                                                                await onDeleteUser(m.id);
                                                                setMembers(prev => prev.filter(x => x.id !== m.id));
                                                            }
                                                        }} 
                                                        className="p-1.5 text-red-600 hover:bg-red-50 rounded" 
                                                        title="刪除"
                                                    >
                                                        <Trash2 size={16}/>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Club Details Modal
        const ClubDetailsModal = ({ isOpen, onClose, club }) => {
            if (!isOpen || !club) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-white flex justify-between items-start">
                            <div>
                                <h2 className="text-2xl font-bold mb-2">{club.name}</h2>
                                <div className="flex flex-wrap gap-2">
                                    <span className="bg-white/20 px-3 py-1 rounded-full text-sm backdrop-blur-sm flex items-center gap-1">
                                        <User size={14} /> {club.teacher}
                                    </span>
                                    <span className="bg-white/20 px-3 py-1 rounded-full text-sm backdrop-blur-sm flex items-center gap-1">
                                        <MapPin size={14} /> {club.location}
                                    </span>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-white/80 hover:text-white hover:bg-white/10 rounded-full p-1 transition">✕</button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto custom-scrollbar space-y-6">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center gap-1"><Clock size={14}/> 上課時間</h3>
                                    <p className="text-gray-800 font-medium">{club.time}</p>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center gap-1"><Users size={14}/> 招收對象</h3>
                                    <p className="text-gray-800 font-medium">{club.grade}</p>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center gap-1"><DollarSign size={14}/> 費用說明</h3>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">學費</span>
                                        <span className="font-bold text-lg text-blue-600">${club.fee}</span>
                                    </div>
                                    <div className="flex justify-between items-center mt-1 pt-1 border-t border-gray-200">
                                        <span className="text-gray-600">材料費</span>
                                        <span className="font-bold text-blue-600">${club.materialFee}</span>
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center gap-1"><List size={14}/> 名額限制</h3>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">正取名額</span>
                                        <span className="font-bold text-green-600">{club.quota} 人</span>
                                    </div>
                                    <div className="flex justify-between items-center mt-1 pt-1 border-t border-gray-200">
                                        <span className="text-gray-600">備取名額</span>
                                        <span className="font-bold text-orange-500">{club.reserveQuota} 人</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 className="text-sm font-bold text-gray-500 uppercase mb-2 flex items-center gap-1"><BookOpen size={14}/> 社團簡介</h3>
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-gray-700 leading-relaxed whitespace-pre-wrap">
                                    {club.description || "暫無簡介說明。"}
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t bg-gray-50 flex justify-end">
                            <button 
                                onClick={onClose}
                                className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-bold transition"
                            >
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthModal = ({ isOpen, onClose, setUser }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [phone, setPhone] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const appId = getAppId();

            if (!isOpen) return null;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let userCredential;
                    if (isRegister) {
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(userCredential.user, { displayName: name });
                        
                        let role = 'user';
                        if (email === 'admin@demo.com') {
                            role = 'admin';
                        } else {
                            try {
                                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                                const q = query(usersRef, limit(1));
                                const snapshot = await getDocs(q);
                                if (snapshot.empty) role = 'admin';
                            } catch (checkErr) {
                                console.warn("Admin check skipped:", checkErr);
                            }
                        }

                        try {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userCredential.user.uid), {
                                name: name,
                                phone: phone,
                                email: email,
                                role: role,
                                createdAt: serverTimestamp()
                            });
                        } catch (profileErr) {
                            console.warn("Profile creation error:", profileErr);
                        }
                    } else {
                        userCredential = await signInWithEmailAndPassword(auth, email, password);
                    }
                    onClose();
                } catch (err) {
                    console.error(err);
                    setError(err.message.includes('auth/invalid-credential') ? '帳號或密碼錯誤' : '發生錯誤，請稍後再試');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="bg-blue-600 p-4 text-white text-center font-bold text-xl">
                            {isRegister ? '家長註冊' : '會員登入'}
                        </div>
                        <div className="p-6">
                            {error && <div className="mb-4 p-2 bg-red-100 text-red-600 text-sm rounded">{error}</div>}
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {isRegister && (
                                    <>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">家長姓名</label>
                                            <input 
                                                type="text" 
                                                required 
                                                className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                                value={name}
                                                onChange={(e) => setName(e.target.value)}
                                                placeholder="請輸入家長真實姓名"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">家長聯絡電話</label>
                                            <input 
                                                type="tel" 
                                                required 
                                                className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                                value={phone}
                                                onChange={(e) => setPhone(e.target.value)}
                                                placeholder="例如: 0912345678"
                                            />
                                        </div>
                                    </>
                                )}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input 
                                        type="email" 
                                        required 
                                        className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder={isRegister ? "建議使用 admin@demo.com 測試管理員" : ""}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                                    <input 
                                        type="password" 
                                        required 
                                        className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={loading}
                                    className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition disabled:opacity-50 flex justify-center"
                                >
                                    {loading ? <Loader2 className="animate-spin" /> : (isRegister ? '註冊' : '登入')}
                                </button>
                            </form>
                            <div className="mt-4 text-center text-sm text-gray-600">
                                {isRegister ? '已有帳號？' : '還沒有帳號？'}
                                <button 
                                    onClick={() => setIsRegister(!isRegister)} 
                                    className="text-blue-600 font-bold ml-1 hover:underline"
                                >
                                    {isRegister ? '立即登入' : '立即註冊'}
                                </button>
                            </div>
                            <button onClick={onClose} className="mt-4 w-full text-gray-400 text-sm hover:text-gray-600">取消</button>
                        </div>
                    </div>
                </div>
            );
        };

        const RegistrationModal = ({ isOpen, onClose, club, onConfirm, userProfile }) => {
            const [studentName, setStudentName] = useState('');
            const [studentClass, setStudentClass] = useState('');
            const [parentName, setParentName] = useState('');
            const [parentPhone, setParentPhone] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setStudentName('');
                    setStudentClass('');
                    // 修正：確保開啟時自動填入資料庫中的姓名與電話
                    setParentName(userProfile?.name || '');
                    setParentPhone(userProfile?.phone || '');
                }
            }, [isOpen, userProfile]);

            if (!isOpen || !club) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onConfirm(studentName, studentClass, parentName, parentPhone);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
                        <div className="bg-blue-600 p-4 text-white font-bold text-xl flex justify-between items-center">
                            <span>報名確認</span>
                            <button onClick={onClose} className="hover:text-blue-200">✕</button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div className="bg-blue-50 p-3 rounded-lg mb-4">
                                <div className="text-sm text-blue-800 font-bold">您正在報名：</div>
                                <div className="text-lg text-blue-900 font-bold">{club.name}</div>
                                <div className="text-sm text-blue-600">{club.time}</div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">學生班級 <span className="text-red-500">*</span></label>
                                    <input 
                                        type="text" 
                                        required 
                                        className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={studentClass}
                                        onChange={(e) => setStudentClass(e.target.value)}
                                        placeholder="例：301"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">學生姓名 <span className="text-red-500">*</span></label>
                                    <input 
                                        type="text" 
                                        required 
                                        className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={studentName}
                                        onChange={(e) => setStudentName(e.target.value)}
                                        placeholder="學生姓名"
                                    />
                                </div>
                            </div>
                            
                            <div className="border-t pt-3 mt-3">
                                <h4 className="text-xs font-bold text-gray-500 uppercase mb-2">家長聯絡資料 (可修改)</h4>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">家長姓名 <span className="text-red-500">*</span></label>
                                        <input 
                                            type="text" 
                                            required 
                                            className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={parentName}
                                            onChange={(e) => setParentName(e.target.value)}
                                            placeholder="家長姓名"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">聯絡電話 <span className="text-red-500">*</span></label>
                                        <input 
                                            type="tel" 
                                            required 
                                            className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={parentPhone}
                                            onChange={(e) => setParentPhone(e.target.value)}
                                            placeholder="請輸入手機或市話"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="pt-2 flex gap-3">
                                <button 
                                    type="button" 
                                    onClick={onClose} 
                                    className="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-200 transition"
                                >
                                    取消
                                </button>
                                <button 
                                    type="submit" 
                                    className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-md"
                                >
                                    確認報名
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ClubFormModal = ({ isOpen, onClose, editData, onSave }) => {
            const [formData, setFormData] = useState({
                name: '', teacher: '', time: '', location: '', grade: '', 
                fee: '', materialFee: '0', quota: '20', reserveQuota: '5', description: ''
            });

            useEffect(() => {
                if (editData) {
                    setFormData({
                        name: editData.name || '',
                        teacher: editData.teacher || '',
                        time: editData.time || '',
                        location: editData.location || '',
                        grade: editData.grade || '',
                        fee: editData.fee || '',
                        materialFee: editData.materialFee || '',
                        quota: editData.quota || '',
                        reserveQuota: editData.reserveQuota || '',
                        description: editData.description || ''
                    });
                } else {
                    setFormData({
                        name: '', teacher: '', time: '', location: '', grade: '', 
                        fee: '', materialFee: '0', quota: '20', reserveQuota: '5', description: ''
                    });
                }
            }, [editData, isOpen]);

            if (!isOpen) return null;

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    ...formData,
                    fee: Number(formData.fee),
                    materialFee: Number(formData.materialFee),
                    quota: Number(formData.quota),
                    reserveQuota: Number(formData.reserveQuota)
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="bg-green-600 p-4 text-white font-bold flex justify-between items-center">
                            <span>{editData ? '編輯社團' : '新增社團'}</span>
                            <button onClick={onClose} className="text-white hover:text-green-200">✕</button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 uppercase">社團名稱</label>
                                <input name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">指導老師</label>
                                <input name="teacher" value={formData.teacher} onChange={handleChange} required className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">上課地點</label>
                                <input name="location" value={formData.location} onChange={handleChange} required className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">上課時間</label>
                                <input name="time" value={formData.time} onChange={handleChange} required placeholder="例: 週一 16:00-17:30" className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">招收年級</label>
                                <input name="grade" value={formData.grade} onChange={handleChange} required placeholder="例: 3-6年級" className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">學費 ($)</label>
                                <input type="number" name="fee" value={formData.fee} onChange={handleChange} required className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">材料費 ($)</label>
                                <input type="number" name="materialFee" value={formData.materialFee} onChange={handleChange} required className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">正取名額</label>
                                <input type="number" name="quota" value={formData.quota} onChange={handleChange} required className="w-full p-2 border rounded" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase">備取名額</label>
                                <input type="number" name="reserveQuota" value={formData.reserveQuota} onChange={handleChange} required className="w-full p-2 border rounded" />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 uppercase">社團簡介/備註</label>
                                <textarea name="description" value={formData.description} onChange={handleChange} rows="3" className="w-full p-2 border rounded"></textarea>
                            </div>
                            <div className="md:col-span-2 flex justify-end gap-2 mt-4">
                                <button type="button" onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                                <button type="submit" className="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold">儲存設定</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null); 
            const [authModalOpen, setAuthModalOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [clubs, setClubs] = useState([]);
            const [settings, setSettings] = useState({ start: '', end: '', manualOpen: null });
            const [registrations, setRegistrations] = useState([]);
            const [userRegistrations, setUserRegistrations] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date().getTime()); 

            const [registeringClub, setRegisteringClub] = useState(null);
            const [viewingClub, setViewingClub] = useState(null); 
            
            // New states for profile and member management
            const [profileModalOpen, setProfileModalOpen] = useState(false);
            const [memberMgmtOpen, setMemberMgmtOpen] = useState(false);

            // Admin State
            const [isAdmin, setIsAdmin] = useState(false);
            const [clubModalOpen, setClubModalOpen] = useState(false);
            const [editingClub, setEditingClub] = useState(null);
            const [adminRegFilter, setAdminRegFilter] = useState('all'); 

            // File Import Refs
            const clubFileInputRef = useRef(null);
            const regFileInputRef = useRef(null);

            const appId = getAppId();

            // --- Effects ---

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date().getTime());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                let unsubUser = null;
                const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (unsubUser) { unsubUser(); unsubUser = null; }

                    if (currentUser) {
                        // 修正：所有使用者都監聽資料庫，確保取得最新姓名/電話
                        const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);
                        
                        unsubUser = onSnapshot(userDocRef, (docSnap) => {
                            let profileData = { name: currentUser.displayName || '家長', phone: '', role: 'user' };
                            
                            if (docSnap.exists()) {
                                profileData = { ...profileData, ...docSnap.data() };
                            }

                            // 處理管理員權限覆蓋，但保留資料庫中的姓名/電話
                            if (currentUser.email === 'admin@demo.com') {
                                profileData.role = 'admin'; 
                                setIsAdmin(true);
                            } else {
                                setIsAdmin(profileData.role === 'admin');
                            }
                            
                            setUserProfile(profileData);
                        }, (error) => {
                            console.warn("Profile stream error:", error);
                            // 錯誤時的回退機制
                            setUserProfile({ name: currentUser.displayName || '家長', phone: '', role: 'user' });
                        });
                    } else {
                        setIsAdmin(false);
                        setUserProfile(null);
                    }
                });
                return () => { unsubscribeAuth(); if (unsubUser) unsubUser(); };
            }, []);

            useEffect(() => {
                const clubsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clubs');
                const unsubClubs = onSnapshot(clubsRef, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    list.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
                    setClubs(list);
                }, (err) => console.error("Clubs stream error:", err));

                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) { setSettings(docSnap.data()); }
                });

                const regsRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
                const unsubRegs = onSnapshot(regsRef, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRegistrations(list);
                }, (err) => console.error("Registrations stream error:", err));

                return () => { unsubClubs(); unsubSettings(); unsubRegs(); };
            }, []);

            useEffect(() => {
                if (user && registrations.length > 0) {
                    const myRegs = registrations.filter(r => r.userId === user.uid);
                    setUserRegistrations(myRegs);
                } else {
                    setUserRegistrations([]);
                }
            }, [user, registrations]);

            // --- Logic ---

            const isRegistrationOpen = useMemo(() => {
                if (settings.manualOpen === true) return true;
                if (settings.manualOpen === false) return false;
                if (!settings.start || !settings.end) return false;
                const now = currentTime; 
                const start = new Date(settings.start).getTime();
                const end = new Date(settings.end).getTime();
                return now >= start && now <= end;
            }, [settings, currentTime]);

            const getClubStats = (clubId) => {
                const clubRegs = registrations.filter(r => r.clubId === clubId);
                const mainCount = clubRegs.filter(r => r.status === 'main').length;
                const reserveCount = clubRegs.filter(r => r.status === 'reserve').length;
                return { mainCount, reserveCount, clubRegs };
            };

            // Helper to get Waiting List number
            const getWaitingOrder = (reg) => {
                if (reg.status !== 'reserve') return null;
                const clubReserves = registrations
                    .filter(r => r.clubId === reg.clubId && r.status === 'reserve')
                    .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                const index = clubReserves.findIndex(r => r.id === reg.id);
                return index !== -1 ? index + 1 : '?';
            };

            const showNotification = (msg, type = 'success') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const handleSaveClub = async (clubData) => {
                try {
                    const clubsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clubs');
                    if (editingClub) {
                        await updateDoc(doc(clubsRef, editingClub.id), clubData);
                        showNotification('社團資料已更新');
                    } else {
                        await addDoc(clubsRef, { ...clubData, createdAt: serverTimestamp() });
                        showNotification('新增社團成功');
                    }
                    setClubModalOpen(false);
                    setEditingClub(null);
                } catch (e) {
                    showNotification('儲存失敗: ' + e.message, 'error');
                }
            };

            const handleDeleteClub = async (id) => {
                if (!confirm('確定要刪除此社團嗎？')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clubs', id));
                    showNotification('社團已刪除');
                } catch (e) {
                    showNotification('刪除失敗', 'error');
                }
            };

            const handleUpdateSettings = async (newSettings) => {
                try {
                    const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                    await setDoc(settingsRef, newSettings, { merge: true });
                    showNotification('系統設定已更新');
                } catch (e) {
                    showNotification('設定更新失敗', 'error');
                }
            };

            const handleRegisterClick = (club) => {
                if (!user) {
                    setAuthModalOpen(true);
                    return;
                }
                const { mainCount, reserveCount } = getClubStats(club.id);
                if (mainCount >= club.quota && reserveCount >= club.reserveQuota) {
                    showNotification('名額已滿', 'error');
                    return;
                }
                setRegisteringClub(club);
            };

            const confirmRegistration = async (studentName, studentClass, parentName, parentPhone) => {
                if (!user || !registeringClub) return;
                const { mainCount, reserveCount } = getClubStats(registeringClub.id);
                let status = 'main';
                if (mainCount >= registeringClub.quota) {
                    if (reserveCount >= registeringClub.reserveQuota) {
                        showNotification('抱歉，就在剛剛名額已滿', 'error');
                        setRegisteringClub(null);
                        return;
                    }
                    status = 'reserve';
                }
                try {
                    const regRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
                    await addDoc(regRef, {
                        userId: user.uid,
                        userEmail: user.email,
                        parentName: parentName || userProfile?.name || '家長',
                        parentPhone: parentPhone || userProfile?.phone || '',
                        studentName: studentName, 
                        studentClass: studentClass, 
                        clubId: registeringClub.id,
                        clubName: registeringClub.name,
                        status: status,
                        timestamp: serverTimestamp()
                    });
                    showNotification(`報名成功！${studentName} 為 ${status === 'main' ? '正取' : '備取'}`);
                    setRegisteringClub(null);
                } catch (e) {
                    showNotification('報名失敗: ' + e.message, 'error');
                }
            };

            const handleCancelRegistration = async (regId) => {
                if (!confirm('確定要取消此筆報名嗎？')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', regId));
                    showNotification('已取消報名');
                } catch (e) {
                    showNotification('取消失敗', 'error');
                }
            };

            const clearAllData = async (collectionName) => {
                if (!confirm('確定要清空資料嗎？請輸入 "DELETE" 確認。')) return;
                const userInput = prompt('請輸入 "DELETE" 確認刪除');
                if (userInput !== 'DELETE') return;
                try {
                    const batch = writeBatch(db);
                    const snapshot = collectionName === 'clubs' ? await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'clubs')) :
                                    await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'registrations'));
                    snapshot.docs.forEach((doc) => { batch.delete(doc.ref); });
                    await batch.commit();
                    showNotification('資料已全部清空');
                } catch (e) { showNotification('清空失敗', 'error'); }
            };

            const exportCSV = (type) => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                if (type === 'clubs') {
                    csvContent += "社團名稱,老師,時間,地點,年級,費用,材料費,正取數,備取數,簡介\n";
                    clubs.forEach(c => {
                        csvContent += `${escapeCSV(c.name)},${escapeCSV(c.teacher)},${escapeCSV(c.time)},${escapeCSV(c.location)},${escapeCSV(c.grade)},${c.fee},${c.materialFee},${c.quota},${c.reserveQuota},${escapeCSV(c.description)}\n`;
                    });
                } else {
                    csvContent += "社團名稱,學生班級,學生姓名,家長姓名,聯絡電話,狀態,報名時間\n";
                    // FIX 2: Sort for Export (Chronological)
                    const sortedRegs = [...registrations].sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    
                    sortedRegs.forEach(r => {
                        const time = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString() : '';
                        csvContent += `${escapeCSV(r.clubName)},${escapeCSV(r.studentClass || '')},${escapeCSV(r.studentName || '')},${escapeCSV(r.parentName || r.userName)},${escapeCSV(r.parentPhone || r.userPhone || '')},${r.status === 'main' ? '正取' : '備取'},${escapeCSV(time)}\n`;
                    });
                }
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${type}_export.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleFileUpload = async (event, type) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const rows = text.split(/\r?\n/).slice(1); // Skip header
                    const batch = writeBatch(db);
                    let count = 0;
                    try {
                        if (type === 'clubs') {
                            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'clubs');
                            rows.forEach(row => {
                                if (!row.trim()) return;
                                const cols = parseCSVLine(row);
                                if (cols.length >= 8) {
                                    const newDoc = doc(collectionRef);
                                    batch.set(newDoc, { name: cols[0] || '', teacher: cols[1] || '', time: cols[2] || '', location: cols[3] || '', grade: cols[4] || '', fee: Number(cols[5]) || 0, materialFee: Number(cols[6]) || 0, quota: Number(cols[7]) || 0, reserveQuota: Number(cols[8]) || 0, description: cols[9] || '', createdAt: serverTimestamp() });
                                    count++;
                                }
                            });
                        } else if (type === 'regs') {
                            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
                            rows.forEach(row => {
                                if (!row.trim()) return;
                                const cols = parseCSVLine(row);
                                // FIX 1: Loosen column check (min 5 cols)
                                if (cols.length >= 5 && cols[0]) {
                                    const newDoc = doc(collectionRef);
                                    const clubName = cols[0] || '';
                                    // Fuzzy match club name if possible
                                    const matchedClub = clubs.find(c => c.name === clubName.trim());
                                    const statusText = cols[5] || '';
                                    const isMain = statusText.includes('正取') || statusText === 'main';
                                    batch.set(newDoc, { 
                                        clubName: clubName, 
                                        clubId: matchedClub ? matchedClub.id : 'imported_unknown_id', 
                                        studentClass: cols[1] || '', 
                                        studentName: cols[2] || '', 
                                        parentName: cols[3] || '', 
                                        parentPhone: cols[4] || '', 
                                        status: isMain ? 'main' : 'reserve', 
                                        userId: 'imported_admin_action', 
                                        userEmail: 'imported', 
                                        timestamp: serverTimestamp() 
                                    });
                                    count++;
                                }
                            });
                        }
                        await batch.commit();
                        showNotification(`成功匯入 ${count} 筆資料`);
                    } catch (err) { console.error(err); showNotification('匯入失敗：格式錯誤或網路問題', 'error'); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            // Handlers for Profile Update
            const handleProfileUpdate = async (name, phone, newPassword) => {
                try {
                    if (!user) return;
                    // Update Auth Profile
                    await updateProfile(user, { displayName: name });
                    // Update Firestore using setDoc with merge: true to fix permission errors on missing docs
                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                    await setDoc(userDocRef, { name, phone }, { merge: true });
                    
                    if (newPassword) {
                        await updatePassword(user, newPassword);
                        showNotification("資料與密碼已更新成功！");
                    } else {
                        showNotification("個人資料更新成功！");
                    }
                } catch (err) {
                    console.error("Update profile error:", err);
                    if (err.code === 'auth/requires-recent-login') {
                        showNotification("修改密碼需要您重新登入後再次操作", 'error');
                    } else {
                        showNotification("更新失敗，請稍後再試", 'error');
                    }
                    throw err; // Propagate to modal
                }
            };

            // Handlers for Admin Member Management
            const handleAdminUpdateUser = async (userId, data) => {
                try {
                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
                    await setDoc(userDocRef, data, { merge: true });
                    showNotification("會員資料已更新");
                } catch (err) {
                    console.error("Update user error:", err);
                    showNotification("更新失敗", 'error');
                }
            };

            const handleAdminDeleteUser = async (userId) => {
                try {
                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
                    await deleteDoc(userDocRef);
                    showNotification("會員資料已刪除 (帳號仍存在)");
                } catch (err) {
                    console.error("Delete user error:", err);
                    showNotification("刪除失敗", 'error');
                }
            };

            const filteredAdminRegs = useMemo(() => {
                let regs = adminRegFilter === 'all' 
                    ? registrations 
                    : registrations.filter(r => r.clubId === adminRegFilter);
                
                return [...regs].sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            }, [registrations, adminRegFilter]);

            const formattedTime = new Date(currentTime).toLocaleTimeString('zh-TW', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const handleManualRefresh = () => {
                showNotification('資料已是最新狀態');
            };

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-800">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    
                    <AuthModal isOpen={authModalOpen} onClose={() => setAuthModalOpen(false)} setUser={setUser} />
                    
                    <RegistrationModal 
                        isOpen={!!registeringClub} 
                        onClose={() => setRegisteringClub(null)} 
                        club={registeringClub}
                        onConfirm={confirmRegistration}
                        userProfile={userProfile}
                    />
                    
                    <ClubDetailsModal 
                        isOpen={!!viewingClub} 
                        onClose={() => setViewingClub(null)} 
                        club={viewingClub} 
                    />
                    
                    <ClubFormModal 
                        isOpen={clubModalOpen} 
                        onClose={() => { setClubModalOpen(false); setEditingClub(null); }} 
                        editData={editingClub}
                        onSave={handleSaveClub}
                    />
                    
                    {/* New Modals */}
                    <ProfileModal 
                        isOpen={profileModalOpen}
                        onClose={() => setProfileModalOpen(false)}
                        user={user}
                        userProfile={userProfile}
                        onUpdate={handleProfileUpdate}
                    />

                    <MemberManagementModal 
                        isOpen={memberMgmtOpen}
                        onClose={() => setMemberMgmtOpen(false)}
                        onEditUser={handleAdminUpdateUser}
                        onDeleteUser={handleAdminDeleteUser}
                    />

                    <header className="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg">
                                    <Users className="text-white" size={24} />
                                </div>
                                <h1 className="text-2xl font-bold text-blue-900 tracking-wide hidden sm:block">新上國小課後社團報名系統</h1>
                                <h1 className="text-xl font-bold text-blue-900 sm:hidden">課後社團報名</h1>
                            </div>

                            <div className="flex items-center gap-4">
                                {user ? (
                                    <div className="flex items-center gap-4">
                                        <div className="text-right hidden md:block cursor-pointer hover:opacity-80" onClick={() => setProfileModalOpen(true)}>
                                            <div className="text-sm font-bold text-gray-700 flex items-center justify-end gap-1">
                                                {userProfile?.name || user.displayName || '家長'} <Edit size={12} className="text-gray-400"/>
                                            </div>
                                            <div className="text-xs text-gray-500 flex items-center justify-end gap-1">
                                                {isAdmin && <Shield size={12} className="text-blue-600" />}
                                                {isAdmin ? '管理員' : (userProfile?.phone || '會員')}
                                            </div>
                                        </div>
                                        <button onClick={() => signOut(auth)} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-sm">
                                            <LogOut size={16} /> <span className="hidden sm:inline">登出</span>
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={() => setAuthModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition shadow-blue-200 shadow-lg flex items-center gap-2">
                                        <User size={16} /> 登入 / 註冊
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
                        {isAdmin && (
                            <>
                                <section className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="bg-gray-800 text-white px-6 py-4 flex justify-between items-center">
                                        <h2 className="text-lg font-bold flex items-center gap-2"><Settings size={20} /> 管理員設定</h2>
                                        <span className="text-xs bg-gray-700 px-2 py-1 rounded">Admin Mode</span>
                                    </div>
                                    <div className="p-6 space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-2">
                                                <label className="block text-sm font-bold text-gray-600">報名開始時間</label>
                                                <input type="datetime-local" value={settings.start || ''} onChange={(e) => setSettings(s => ({...s, start: e.target.value}))} className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"/>
                                            </div>
                                            <div className="space-y-2">
                                                <label className="block text-sm font-bold text-gray-600">報名結束時間</label>
                                                <div className="flex gap-2">
                                                    <input type="datetime-local" value={settings.end || ''} onChange={(e) => setSettings(s => ({...s, end: e.target.value}))} className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"/>
                                                    <button 
                                                        onClick={() => handleUpdateSettings({ ...settings, manualOpen: null })} 
                                                        className="bg-blue-600 text-white px-4 rounded-lg font-bold hover:bg-blue-700"
                                                        title="儲存並清除強制開關設定，恢復依時間排程"
                                                    >
                                                        儲存並啟用排程
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-3 pt-4 border-t border-gray-100">
                                            <button onClick={() => handleUpdateSettings({ ...settings, manualOpen: true })} className="bg-green-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-600 flex items-center gap-2"><CheckCircle size={18} /> 立即開放</button>
                                            <button onClick={() => handleUpdateSettings({ ...settings, manualOpen: false })} className="bg-gray-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-gray-700 flex items-center gap-2"><AlertTriangle size={18} /> 立即關閉</button>
                                            
                                            <button onClick={() => setMemberMgmtOpen(true)} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 flex items-center gap-2"><Users size={18} /> 會員管理</button>
                                            
                                            <div className="flex-grow"></div>
                                            <button onClick={() => setClubModalOpen(true)} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2"><Plus size={18} /> 新增社團</button>
                                        </div>
                                        {/* Data Management Panel (Keep existing code) */}
                                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-2">
                                                <h3 className="font-bold text-gray-700">社團資料管理</h3>
                                                <div className="flex gap-2 flex-wrap">
                                                    <button onClick={() => exportCSV('clubs')} className="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 flex items-center gap-1"><Download size={14}/> 匯出清單</button>
                                                    <input type="file" accept=".csv" ref={clubFileInputRef} onChange={(e) => handleFileUpload(e, 'clubs')} className="hidden" />
                                                    <button onClick={() => clubFileInputRef.current.click()} className="bg-purple-500 text-white px-3 py-1.5 rounded text-sm hover:bg-purple-600 flex items-center gap-1"><FileUp size={14}/> 匯入社團</button>
                                                    <button onClick={() => clearAllData('clubs')} className="bg-red-500 text-white px-3 py-1.5 rounded text-sm hover:bg-red-600 flex items-center gap-1"><Trash2 size={14}/> 清空社團</button>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                <h3 className="font-bold text-gray-700">報名資料管理</h3>
                                                <div className="flex gap-2 flex-wrap">
                                                    <button onClick={() => exportCSV('regs')} className="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 flex items-center gap-1"><FileSpreadsheet size={14}/> 匯出報名</button>
                                                    <input type="file" accept=".csv" ref={regFileInputRef} onChange={(e) => handleFileUpload(e, 'regs')} className="hidden" />
                                                    <button onClick={() => regFileInputRef.current.click()} className="bg-purple-500 text-white px-3 py-1.5 rounded text-sm hover:bg-purple-600 flex items-center gap-1"><FileUp size={14}/> 匯入報名</button>
                                                    <button onClick={() => clearAllData('regs')} className="bg-red-500 text-white px-3 py-1.5 rounded text-sm hover:bg-red-600 flex items-center gap-1"><Trash2 size={14}/> 清空報名</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                {/* Admin Registration Overview */}
                                <section className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="px-6 py-4 border-b border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                                        <div className="flex items-center gap-4">
                                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                                <List size={20} /> 報名情形總覽
                                            </h2>
                                            <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-md">
                                                {formattedTime} 更新 • 共 {filteredAdminRegs.length} 筆
                                            </span>
                                            <button onClick={handleManualRefresh} className="text-gray-400 hover:text-blue-600 transition" title="重新整理">
                                                <RefreshCw size={16} />
                                            </button>
                                        </div>
                                        <div className="flex items-center gap-2 w-full sm:w-auto">
                                            <Filter size={16} className="text-gray-500" />
                                            <select 
                                                value={adminRegFilter} 
                                                onChange={(e) => setAdminRegFilter(e.target.value)}
                                                className="border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none flex-grow sm:w-64"
                                            >
                                                <option value="all">全部社團 ({registrations.length}筆)</option>
                                                {clubs.map(c => (
                                                <option key={c.id} value={c.id}>
                                                    {c.name} ({getClubStats(c.id).mainCount + getClubStats(c.id).reserveCount}人)
                                                </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                                        <table className="w-full text-left">
                                            <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold sticky top-0">
                                                <tr>
                                                    <th className="px-6 py-3">社團名稱</th>
                                                    <th className="px-6 py-3">學生班級</th>
                                                    <th className="px-6 py-3">學生姓名</th>
                                                    <th className="px-6 py-3">家長姓名</th>
                                                    <th className="px-6 py-3">電話</th>
                                                    <th className="px-6 py-3">狀態</th>
                                                    <th className="px-6 py-3 text-right">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {filteredAdminRegs.length === 0 ? (
                                                    <tr><td colSpan="7" className="px-6 py-8 text-center text-gray-400">無符合條件的報名資料</td></tr>
                                                ) : (
                                                    filteredAdminRegs.map(reg => (
                                                        <tr key={reg.id} className="hover:bg-gray-50">
                                                            <td className="px-6 py-3 font-medium">{reg.clubName}</td>
                                                            <td className="px-6 py-3">{reg.studentClass}</td>
                                                            <td className="px-6 py-3">{reg.studentName}</td>
                                                            <td className="px-6 py-3 text-sm text-gray-600">{reg.parentName}</td>
                                                            <td className="px-6 py-3 text-sm text-gray-600">{reg.parentPhone}</td>
                                                            <td className="px-6 py-3">
                                                                {/* FIX 3: Display Waiting List Number */}
                                                                <span className={`px-2 py-1 rounded text-xs font-bold ${reg.status === 'main' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>
                                                                    {reg.status === 'main' ? '正取' : `備取 (${getWaitingOrder(reg)})`}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-3 text-right">
                                                                <button 
                                                                    onClick={() => handleCancelRegistration(reg.id)}
                                                                    className="text-red-500 hover:bg-red-50 p-1.5 rounded transition" 
                                                                    title="刪除報名"
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </>
                        )}

                        <div className={`p-4 rounded-xl border flex items-center justify-between ${isRegistrationOpen ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                            <div className="flex items-center gap-3">
                                <Clock className={isRegistrationOpen ? 'text-green-600' : 'text-red-600'} />
                                <div>
                                    <h3 className="font-bold text-lg">{isRegistrationOpen ? '目前開放報名中' : '目前非報名時間'}</h3>
                                    <p className="text-sm opacity-80">{settings.start && settings.end ? `${settings.start.replace('T', ' ')} ~ ${settings.end.replace('T', ' ')}` : '尚未設定時間'}</p>
                                </div>
                            </div>
                        </div>

                        {/* My Registrations List */}
                        {user && !isAdmin && (
                            <section className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="px-6 py-4 border-b border-gray-200 bg-blue-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                                    <div className="flex items-center gap-4">
                                        <h2 className="text-xl font-bold text-blue-900 flex items-center gap-2">
                                            <List size={20} /> 我的報名清單
                                        </h2>
                                        <span className="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded-md">
                                            {formattedTime} 更新 • 共 {userRegistrations.length} 筆
                                        </span>
                                        <button onClick={handleManualRefresh} className="text-blue-400 hover:text-blue-600 transition" title="重新整理">
                                            <RefreshCw size={16} />
                                        </button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
                                            <tr>
                                                <th className="px-6 py-3">社團名稱</th>
                                                <th className="px-6 py-3">學生班級</th>
                                                <th className="px-6 py-3">學生姓名</th>
                                                <th className="px-6 py-3">狀態</th>
                                                <th className="px-6 py-3 text-right">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {userRegistrations.length === 0 ? (
                                                <tr>
                                                    <td colSpan="5" className="px-6 py-8 text-center text-gray-400">
                                                        目前沒有報名任何社團
                                                    </td>
                                                </tr>
                                            ) : (
                                                userRegistrations.map(reg => (
                                                    <tr key={reg.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 font-bold text-gray-800">{reg.clubName}</td>
                                                        <td className="px-6 py-4 text-gray-600">{reg.studentClass}</td>
                                                        <td className="px-6 py-4 text-gray-600">{reg.studentName}</td>
                                                        <td className="px-6 py-4">
                                                            {/* FIX 3: Display Waiting List Number */}
                                                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                                reg.status === 'main' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'
                                                            }`}>
                                                                {reg.status === 'main' ? '正取' : `備取 (${getWaitingOrder(reg)})`}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 text-right">
                                                            <button 
                                                                onClick={() => handleCancelRegistration(reg.id)}
                                                                className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-full transition"
                                                                title="取消報名"
                                                            >
                                                                <XCircle size={20} />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                        )}

                        <section className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div className="px-6 py-4 border-b border-gray-200"><h2 className="text-xl font-bold text-gray-800">所有社團列表</h2></div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
                                        <tr>
                                            <th className="px-6 py-3">社團名稱</th>
                                            <th className="px-6 py-3">老師</th>
                                            <th className="px-6 py-3">時間</th>
                                            <th className="px-6 py-3">地點</th>
                                            <th className="px-6 py-3">年級</th>
                                            <th className="px-6 py-3">費用 (學+材)</th>
                                            <th className="px-6 py-3 text-center">名額 (正/備)</th>
                                            <th className="px-6 py-3 text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {clubs.length === 0 ? (
                                            <tr><td colSpan="8" className="px-6 py-12 text-center text-gray-400">尚無社團資料</td></tr>
                                        ) : (
                                            clubs.map((club) => {
                                                const { mainCount, reserveCount } = getClubStats(club.id);
                                                const isFull = mainCount >= club.quota && reserveCount >= club.reserveQuota;
                                                return (
                                                    <tr key={club.id} className="hover:bg-blue-50 transition group">
                                                        <td className="px-6 py-4"><div className="font-bold text-blue-900">{club.name}</div>
                                                        </td>
                                                        <td className="px-6 py-4 text-sm text-gray-700">{club.teacher}</td>
                                                        <td className="px-6 py-4 text-sm text-gray-700"><div className="flex items-center gap-1"><Clock size={14} className="text-gray-400"/>{club.time}</div></td>
                                                        <td className="px-6 py-4 text-sm text-gray-700"><div className="flex items-center gap-1"><MapPin size={14} className="text-gray-400"/>{club.location}</div></td>
                                                        <td className="px-6 py-4 text-sm text-gray-700"><span className="bg-gray-100 px-2 py-1 rounded text-xs">{club.grade}</span></td>
                                                        <td className="px-6 py-4 text-sm text-gray-700"><div className="font-medium">${club.fee} + ${club.materialFee}</div></td>
                                                        <td className="px-6 py-4 text-center"><div className="text-sm"><span className={`font-bold ${mainCount >= club.quota ? 'text-red-500' : 'text-green-600'}`}>{mainCount}/{club.quota}</span><span className="text-xs text-gray-400 mx-1">(正)</span><span className="text-gray-400">|</span><span className={`ml-1 font-bold ${reserveCount >= club.reserveQuota ? 'text-red-500' : 'text-orange-500'}`}>{reserveCount}/{club.reserveQuota}</span><span className="text-xs text-gray-400 mx-1">(備)</span></div></td>
                                                        <td className="px-6 py-4 text-center">
                                                            <div className="flex items-center justify-center gap-2">
                                                                <button 
                                                                    onClick={() => setViewingClub(club)}
                                                                    className="p-1.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition"
                                                                    title="查看詳情"
                                                                >
                                                                    <Info size={16} />
                                                                </button>

                                                                {isAdmin ? (
                                                                    <>
                                                                    <button onClick={() => { setEditingClub(club); setClubModalOpen(true); }} className="p-1.5 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"><Edit size={16}/></button>
                                                                    <button onClick={() => handleDeleteClub(club.id)} className="p-1.5 bg-red-100 text-red-600 rounded hover:bg-red-200"><Trash2 size={16}/></button>
                                                                    </>
                                                                ) : (
                                                                    <button onClick={() => handleRegisterClick(club)} disabled={!isRegistrationOpen || isFull} className={`px-4 py-1.5 rounded text-sm font-bold w-24 transition ${!isRegistrationOpen ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : isFull ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 shadow-md'}`}>{isFull ? '已額滿' : '報名'}</button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </main>
                    <footer className="bg-white border-t mt-12 py-8 text-center text-gray-500 text-sm"><p>© {new Date().getFullYear()} 新上國小課後社團報名系統 | System Designed for Demo</p></footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        document.body.style.display = 'block';
    </script>
</body>
</html>